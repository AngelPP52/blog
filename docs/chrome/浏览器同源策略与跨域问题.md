同源策略有助于阻隔恶意文档，减少可能被攻击的媒介。

同源策略指的是：协议+域名+端口，三者皆相同，才是同一个域，否则都是跨域。

为什么要有同源策略？

- 防止点击第三方网站，并且将包含登录信息的cookie暴露出去
- 防止第三方网站，通过`iframe`可以拿到你网站的真实dom，进行操作

解决跨域问题的方案：

- **jsonp**

原理：通过动态创建一个`<script>`元素，向服务器发送请求，请求地址后面带上`?callback=xxx`（表示请求完成后的回调），并且回调的参数是JSON形式

```js
function jsonp(url){
    const script =document.createElement('script');
	script.setArribute('type', 'text/javascript');
    script.src = src;
    document.body.appendChild(script);
}

window.onload = function(){
    jsonp('localhost:8080/users?callback=foo');
    function foo(data){
		console.log('users=', data)
    }
}
```

> 1. 存在安全性的问题，需要网站双方协商token等身份认证
> 2. 只能get，不能post
> 3. 可能因此被注入恶意代码（应采用字符串过滤）

- **cors**

属于一种W3C标准，“跨域资源共享”，它可以指定哪些域名和哪些自定义请求头被允许跨域访问。需要后台代码的配合：

`Access-Control-Allow-Origin` - 被允许的域名

`Access-Control-Allow-Headers` - 被允许的请求头

`Access-Control-Allow-Methods` - 被允许的请求方法

`Access-Control-Max-Age` - options请求最大存活时间（一定时间内不再发预检请求）

一般是在预检请求阶段，带上这些字段：`Access-Control-Request-Headers`，`Access-Control-Request-Method`，服务器才能判断这个请求是否允许跨域

- **nginx代理转发**
- **nodejs中间件代理跨域**
- **document.domain + iframe**

> 使用`document.domain`来允许子域安全访问父域时，需要父域和子域设置相同的值。**只是设置一个都可能会导致权限错误**。

同源策略，除了限制了ajax请求，还限制了浏览器中不同域的框架之间进行js交互。

尽管我们能够拿到不同框架之间彼此的window对象，但是却不能获取window对象的属性和方法（postMessage除外）

**案例**：页面中的iframe框架（src属性就是它的地址），我们无法通过js来获取iframe中的东西

**解决思路**：将这两个页面的document.domain设成相同的域名。需要注意的是，document.domain只能设置成自身或更高一级的父域。（a.b.example.com，可以设成b.example.com，example.com等，但不能设成c.a.b.example.com子域或者baidu.com这种不同主域的值）

- **document.name + iframe**

同一个窗口（window）的生命周期内，窗口载入的所有页面都共享一个window.name

- **localtion.hash + iframe**

- **postMessage**

与document.domain类似，都是不同域架构之间交互。

发送消息的window：`window.postMessage(message, targetOrigin)`

接收消息的window：`window.message = fun() {}`